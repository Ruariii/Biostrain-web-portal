<!DOCTYPE html>
{% extends 'base.html' %}
{% block content %}
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <title>Player Analysis</title>
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
  <div>
    {% for message in get_flashed_messages() %}

      <div class="alert alert-dark alert-dismissible fade show" role="alert">
        <strong>{{ message }}</strong>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

    {% endfor %}
    <br>
  </div>
  <h4> Player View: {{name}} </h4>
  <hr>
  <br>


  <div class="card">
  <h5 class="card-header">Featured: user activity</h5>
  <div class="card-body">
    <h5 class="card-title">Activity log</h5>
    <p class="card-text">Monitor your activity on the Biostrain system.</p>
    <canvas id="activityChart" width="100%" height="40%"></canvas>
    <hr>
    <h5 class="card-title">Last 5 completed tests:</h5>
    <br>
    <table id="activityTable" class="table table-hover">
      <tr class="table-secondary">
        <th scope="col" style="text-align:center">  </th>
        <th scope="col" style="text-align:center"> Squad </th>
        <th scope="col" style="text-align:center"> User </th>
        <th scope="col" style="text-align:center"> Test date </th>
        <th scope="col" style="text-align:center"> Protocol </th>
        <th scope="col" style="text-align:center"> Transformational zone </th>
        <th scope="col" style="text-align:center"> Left peak force </th>
        <th scope="col" style="text-align:center"> Right peak force</th>
      </tr>
      <tr>
        <th scope="Row" style="text-align:center"> 1 </th>
        <td style="text-align:center"> {{ dataArrayHead[4][0] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[4][1] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[4][2] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[4][3] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[4][4] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[4][5] }} kg </td>
        <td style="text-align:center"> {{ dataArrayHead[4][6] }} kg </td>
      </tr>
      <tr>
        <th scope="Row" style="text-align:center"> 2 </th>
        <td style="text-align:center"> {{ dataArrayHead[3][0] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[3][1] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[3][2] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[3][3] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[3][4] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[3][5] }} kg </td>
        <td style="text-align:center"> {{ dataArrayHead[3][6] }} kg </td>
      </tr>
      <tr>
        <th scope="Row" style="text-align:center"> 3 </th>
        <td style="text-align:center"> {{ dataArrayHead[2][0] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[2][1] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[2][2] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[2][3] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[2][4] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[2][5] }} kg </td>
        <td style="text-align:center"> {{ dataArrayHead[2][6] }} kg </td>
      </tr>
      <tr>
        <th scope="Row" style="text-align:center"> 4 </th>
        <td style="text-align:center"> {{ dataArrayHead[1][0] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[1][1] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[1][2] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[1][3] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[1][4] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[1][5] }} kg </td>
        <td style="text-align:center"> {{ dataArrayHead[1][6] }} kg </td>
      </tr>
      <tr>
        <th scope="Row" style="text-align:center"> 5 </th>
        <td style="text-align:center"> {{ dataArrayHead[0][0] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[0][1] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[0][2] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[0][3] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[0][4] }} </td>
        <td style="text-align:center"> {{ dataArrayHead[0][5] }} kg </td>
        <td style="text-align:center"> {{ dataArrayHead[0][6] }} kg </td>
      </tr>
    </table>
  </div>
  </div>
  <br><br>


  <div class="card">
    <h5 class="card-header">Featured: baseline protocols</h5>
    <div class="card-body">
      <p class="card-text">Baseline protocols allow us to monitor your performance when fresh and give insights into your absolute performance capabilities as well as your performance potential.</p>
  <h5 class="card-title">Last baseline session:</h5>
    <p> <strong>Protocol:</strong> {{ lastBaselineList[0]|safe }}
      <strong>Date:</strong> {{ lastBaselineList[1]|safe }}</p>
    <!-- First dropdown for selecting the metric -->
<label for="metric-select">Select Metric:</label>
<select id="metric-select">
  <option value="front-leg-force-150ms">Front leg force at 150ms</option>
  <option value="front-leg-peak-force">Front leg peak force</option>
  <option value="back-leg-force-150ms">Back leg force at 150ms</option>
  <option value="back-leg-peak-force">Back leg peak force</option>
  <option value="crush-factor-150ms">Crush factor at 150ms</option>
  <option value="peak-crush-factor">Peak crush factor</option>
</select>
    <canvas id="myChart" width="100%" height="40%"></canvas>
    <br>
    <table id="last-baseline-table" class="table table-bordered border-dark" width="100%" style="text-align:center"></table>
  <br><hr><br>
    <h5 class="card-title">Baseline progress tracker:</h5>
    <p> Track your progress over time across all baseline protocols </p>
        <!-- First dropdown for selecting the metric -->
  <label for="bh-metric-select">Select Metric:</label>
  <select id="bh-metric-select">
    <option value="front-leg-force-150ms">Front leg force at 150ms</option>
    <option value="front-leg-peak-force">Front leg peak force</option>
    <option value="back-leg-force-150ms">Back leg force at 150ms</option>
    <option value="back-leg-peak-force">Back leg peak force</option>
    <option value="crush-factor-150ms">Crush factor at 150ms</option>
    <option value="peak-crush-factor">Peak crush factor</option>
  </select>
  <!-- Second dropdown for selecting the data type -->
  <label for="bh-type-select">Select Data Type:</label>
  <select id="bh-type-select">
    <option value="max">Maximum scores</option>
    <option value="avg">Average scores</option>
  </select>
    <canvas id="baselineHistoricalChart" width="100%" height="40%"></canvas>
    <br>
    <table id="baseline-historical-table" class="table table-bordered border-dark" width="100%" style="text-align:center"></table>
  <br>

  </div>
  </div>
  <br><br>


  <div class="card">
    <h5 class="card-header">Featured: fatigue protocols</h5>
    <div class="card-body">
      <p class="card-text">Fatigue protocols are designed to investigate how your performance breaks down when you become fatigued, this can help set limits for training intensity and inform decisions about recovery.
    Becoming fatigued impacts your ability to generate force rapidly. The solid lines represent your maximum (fresh) capability, while the dashed lines represent your best efforts in a fatigued state.
    </p>
  <h5 class="card-title">Last fatigue session:</h5>
    <p> <strong>Protocol:</strong> {{ lastFatigueList[0]|safe }}
      <strong>Date:</strong> {{ lastFatigueList[1]|safe }}</p>
<label for="fatigue-metric-select">Select Metric:</label>
<select id="fatigue-metric-select">
  <option value="front-leg-force-150ms">Front leg force at 150ms</option>
  <option value="front-leg-peak-force">Front leg peak force</option>
  <option value="back-leg-force-150ms">Back leg force at 150ms</option>
  <option value="back-leg-peak-force">Back leg peak force</option>
  <option value="crush-factor-150ms">Crush factor at 150ms</option>
  <option value="peak-crush-factor">Peak crush factor</option>
</select>
    <canvas id="myFatigueChart" width="100%" height="40%"></canvas>
    <br>
    <table id="last-fatigue-table" class="table table-bordered border-dark" width="100%" style="text-align:center"></table>

  <br><hr><br>
    <h5 class="card-title">Fatigue test progress tracker:</h5>
    <p> Track your progress over time across all fatigue protocols </p>
        <!-- First dropdown for selecting the metric -->
  <label for="fh-metric-select">Select Metric:</label>
  <select id="fh-metric-select">
    <option value="front-leg-force-150ms">Front leg force at 150ms</option>
    <option value="front-leg-peak-force">Front leg peak force</option>
    <option value="back-leg-force-150ms">Back leg force at 150ms</option>
    <option value="back-leg-peak-force">Back leg peak force</option>
    <option value="crush-factor-150ms">Crush factor at 150ms</option>
    <option value="peak-crush-factor">Peak crush factor</option>
  </select>
  <!-- Second dropdown for selecting the data type -->
  <label for="fh-type-select">Select Data Type:</label>
  <select id="fh-type-select">
    <option value="max">Maximum scores</option>
    <option value="avg">Average scores</option>
  </select>
    <canvas id="fatigueHistoricalChart" width="100%" height="40%"></canvas>
    <br>
    <table id="fatigue-historical-table" class="table table-bordered border-dark" width="100%" style="text-align:center"></table>
<br>
</div>
  </div>
<br><br>
  <div class="card">
  <h5 class="card-header">Featured: Summary report</h5>
  <div class="card-body" style="text-align:center">
  <p class="card-text" style="text-align:left"> View best, worst and average peak force scores across each protocol, transition zone and leg: </p>
     {{ report|safe }}
  </div>
  </div>

  <script>
  // Get the data from the LHTZ_data and RHTZ_data dictionaries
var LHTZ_data = {{ LHTZ_baseline|tojson|safe }};
var RHTZ_data = {{ RHTZ_baseline|tojson|safe }};

// Extract the data for the chart
var LHTZ_chartData = LHTZ_data['session']['Front leg force at 150ms'];
var RHTZ_chartData = RHTZ_data['session']['Front leg force at 150ms'];

// Get the labels for the chart
var labels = LHTZ_data['session']['index'];

// Create a new chart
const ctx = document.getElementById("myChart").getContext("2d");
const myChart = new Chart(ctx, {
  type: "bar",
  data: {
    labels: labels,
    datasets: [{
        label: 'LHTZ',
        data: LHTZ_chartData,
        backgroundColor: [
          'rgba(255, 99, 132, 0.2)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)'
        ],
        borderWidth: 1
      },
      {
        label: 'RHTZ',
        data: RHTZ_chartData,
        backgroundColor: [
          'rgba(54, 162, 235, 0.2)'
        ],
        borderColor: [
          'rgba(54, 162, 235, 1)'
        ],
        borderWidth: 1
      }
    ]
  },
  options: {
    plugins: {
      tooltip: {
        callbacks: {
          label: function(tooltipItem) {
            var Data = myChart.data;
            var index = tooltipItem.dataIndex;
            console.log(index)
            var LHTZ_value = 0;
            var RHTZ_value = 0;
            if (Data && Data.datasets[0].data[index]) {
                LHTZ_value = Data.datasets[0].data[index];
            }
            if (Data && Data.datasets[1].data[index]) {
                RHTZ_value = Data.datasets[1].data[index];
            }
            var difference = RHTZ_value - LHTZ_value;
            var difference_percent = (difference / LHTZ_value * 100).toFixed(2);
            return "LHTZ: " + LHTZ_value + " kg\n" + "RHTZ: " + RHTZ_value + " kg\n" + "Asymmetry: " + difference_percent + "%";
          }
        }
      }
    },
    scales: {
      y: {
        title: {
          text: 'Force (kg)',
          color: 'black',
          display: true
        },
        border: {
          color: 'black'
        },
        ticks: {
          color: 'black'
        }
      },
      x: {
        title: {
          text: 'Test number',
          color: 'black',
          display: true
        },
        border: {
          color: 'black'
        },
        ticks: {
          color: 'black'
        }
      },
      yAxes: [{
        ticks: {
          beginAtZero: true
        }
      }]
    }
  }
});
function filterData(metric) {
    // Retrieve the data for LHTZ and RHTZ
    var LHTZ_data = {{ LHTZ_baseline|tojson|safe }};
    var RHTZ_data = {{ RHTZ_baseline|tojson|safe }};

    // Filter the data based on the selected metric
    var LHTZ_filteredData = LHTZ_data['session'][metric];
    var RHTZ_filteredData = RHTZ_data['session'][metric];

    // Return the filtered data
    return {'LHTZ': LHTZ_filteredData, 'RHTZ': RHTZ_filteredData};
}

function updateChartData(filteredData) {
    // Update the data for the LHTZ dataset
    myChart.data.datasets[0].data = filteredData['LHTZ'];
    // Update the data for the RHTZ dataset
    myChart.data.datasets[1].data = filteredData['RHTZ'];
    // Update the chart
    myChart.update();
}

function updateTable(filteredData, selectedMetric) {
    // Get a reference to the table element
    var table = document.getElementById("last-baseline-table");
    // Clear the existing content of the table
    table.innerHTML = "";

    // Create the table headers
    var headers = ["Test number", "LHTZ score (kg)", "RHTZ score (kg)", "Asymmetry (%)"];
    var headerRow = document.createElement("tr");
    for (var i = 0; i < headers.length; i++) {
        var headerCell = document.createElement("th");
        headerCell.innerHTML = headers[i];
        headerRow.appendChild(headerCell);
    }
    table.appendChild(headerRow);

    // Create the table rows
    for (var i = 0; i < labels.length; i++) {
        var row = document.createElement("tr");
        var testCell = document.createElement("td");
        testCell.innerHTML = labels[i];
        row.appendChild(testCell);

        var LHTZValue = filteredData['LHTZ'][i];
        var RHTZValue = filteredData['RHTZ'][i];
        var LHTZCell = document.createElement("td");
        LHTZCell.innerHTML = LHTZValue;
        row.appendChild(LHTZCell);

        var RHTZCell = document.createElement("td");
        RHTZCell.innerHTML = RHTZValue;
        row.appendChild(RHTZCell);

        var percentageDiff = ((RHTZValue - LHTZValue) / LHTZValue) * 100;
        var diffCell = document.createElement("td");
        diffCell.innerHTML = percentageDiff.toFixed(2);
        row.appendChild(diffCell);

        table.appendChild(row);
    }
}

// Get references to the select elements
var metricSelect = document.getElementById("metric-select");
metricSelect.addEventListener("change", updateChart);
// Function to update the chart when a new option is selected
function updateChart() {
    var selectedMetric = metricSelect.options[metricSelect.selectedIndex].text;
    var filteredData = filterData(selectedMetric);
    updateChartData(filteredData);
    updateTable(filteredData, selectedMetric);
  }
updateChart();
  </script>

<script>
  // Get the data from the LHTZ_data and RHTZ_data dictionaries
var LHTZ_data = {{ LHTZ_fatigue|tojson|safe }};
var RHTZ_data = {{ RHTZ_fatigue|tojson|safe }};

// Extract the data for the chart
var LHTZ_chartData = LHTZ_data['session']['Front leg force at 150ms'];
var RHTZ_chartData = RHTZ_data['session']['Front leg force at 150ms'];

// Get the labels for the chart
var labels2 = LHTZ_data['session']['index'];

// Create a new chart
const ctx2 = document.getElementById("myFatigueChart").getContext("2d");
const myFatigueChart = new Chart(ctx2, {
    type: "line",
    data: {
        labels: labels2,
        datasets: [
        {
            label: 'LHTZ',
            data: LHTZ_chartData,
            backgroundColor: [
                'rgba(128,0,128,0.2)'
            ],
            borderColor: [
                'rgba(128,0,128,1)'
            ],
            borderWidth: 1
        },
        {
            label: 'RHTZ',
            data: RHTZ_chartData,
            backgroundColor: [
                'rgba(0,128,0,0.2)'
            ],
            borderColor: [
                'rgba(0,128,0,1)'
            ],
            borderWidth: 1
        }
        ]
    },
        options: {
          plugins: {
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  var Data = myFatigueChart.data;
                  var index = tooltipItem.dataIndex;
                  console.log(index)
                  var LHTZ_value = 0;
                  var RHTZ_value = 0;
                  if (Data && Data.datasets[0].data[index]) {
                      LHTZ_value = Data.datasets[0].data[index];
                  }
                  if (Data && Data.datasets[1].data[index]) {
                      RHTZ_value = Data.datasets[1].data[index];
                  }
                  var difference = RHTZ_value - LHTZ_value;
                  var difference_percent = (difference / LHTZ_value * 100).toFixed(2);
                  return "LHTZ: " + LHTZ_value + " kg\n" + "RHTZ: " + RHTZ_value + " kg\n" + "Asymmetry: " + difference_percent + "%";
                }
              }
            }
          },
          scales: {
              y: {
                title: {
                  text: 'Force (kg)',
                  color: 'black',
                  display: true
                },
                border: {
                  color: 'black'
                },
                ticks: {
                  color:'black'
                }
              },
              x: {
                title: {
                  text: 'Test number',
                  color: 'black',
                  display: true
                },
                border: {
                  color: 'black'
                },
                ticks: {
                  color:'black'
                }
              },
              yAxes: [{
                  ticks: {
                      beginAtZero: true
                  }
              }]
          }
      }
  });

function filterData2(metric) {
    // Retrieve the data for LHTZ and RHTZ
    var LHTZ_data = {{ LHTZ_fatigue|tojson|safe }};
    var RHTZ_data = {{ RHTZ_fatigue|tojson|safe }};

    // Filter the data based on the selected metric
    var LHTZ_filteredData = LHTZ_data['session'][metric];
    var RHTZ_filteredData = RHTZ_data['session'][metric];

    // Return the filtered data
    return {'LHTZ': LHTZ_filteredData, 'RHTZ': RHTZ_filteredData};
}

function updateChartData2(filteredData2) {
    // Update the data for the LHTZ dataset
    myFatigueChart.data.datasets[0].data = filteredData2['LHTZ'];
    // Update the data for the RHTZ dataset
    myFatigueChart.data.datasets[1].data = filteredData2['RHTZ'];
    // Update the chart
    myFatigueChart.update();
}

function updateTable2(filteredData2, selectedMetric2) {
    // Get a reference to the table element
    var table = document.getElementById("last-fatigue-table");
    // Clear the existing content of the table
    table.innerHTML = "";

    // Create the table headers
    var headers = ["Test number", "LHTZ score (kg)", "RHTZ score (kg)", "Asymmetry (%)"];
    var headerRow = document.createElement("tr");
    for (var i = 0; i < headers.length; i++) {
        var headerCell = document.createElement("th");
        headerCell.innerHTML = headers[i];
        headerRow.appendChild(headerCell);
    }
    table.appendChild(headerRow);

    // Create the table rows
    for (var i = 0; i < labels2.length; i++) {
        var row = document.createElement("tr");
        var testCell = document.createElement("td");
        testCell.innerHTML = labels[i];
        row.appendChild(testCell);

        var LHTZValue = filteredData2['LHTZ'][i];
        var RHTZValue = filteredData2['RHTZ'][i];
        var LHTZCell = document.createElement("td");
        LHTZCell.innerHTML = LHTZValue;
        row.appendChild(LHTZCell);

        var RHTZCell = document.createElement("td");
        RHTZCell.innerHTML = RHTZValue;
        row.appendChild(RHTZCell);

        var percentageDiff = ((RHTZValue - LHTZValue) / LHTZValue) * 100;
        var diffCell = document.createElement("td");
        diffCell.innerHTML = percentageDiff.toFixed(2);
        row.appendChild(diffCell);

        table.appendChild(row);
    }
}

// Get references to the select elements
var metricSelect2 = document.getElementById("fatigue-metric-select");
metricSelect2.addEventListener("change", updateChart2);
// Function to update the chart when a new option is selected
function updateChart2() {
    var selectedMetric2 = metricSelect2.options[metricSelect2.selectedIndex].text;
    var filteredData2 = filterData2(selectedMetric2);
    updateChartData2(filteredData2);
    updateTable2(filteredData2, selectedMetric2);
  }
updateChart2();
  </script>

  <script>
  // Get the data from the LHTZ_data and RHTZ_data dictionaries
var data3 = {{ baselineHistoricalData|tojson|safe }};

// Extract the session names
var session_names = [];
for (var session in data3) {
  session_names.push(session);
}

// Extract the data for the chart
var BH_LHTZ_data = [];
var BH_RHTZ_data = [];
for (var session in data3) {
  BH_LHTZ_data.push(data3[session]['LHTZ']['max']['Front leg force at 150ms'][0]);
  BH_RHTZ_data.push(data3[session]['RHTZ']['max']['Front leg force at 150ms'][0]);
}

// Create a new chart
const ctx3 = document.getElementById("baselineHistoricalChart").getContext("2d");
const baselineHistoricalChart = new Chart(ctx3, {
  type: "bar",
  data: {
    labels: session_names,
    datasets: [{
        label: 'LHTZ',
        data: BH_LHTZ_data,
        backgroundColor: [
          'rgba(255, 99, 132, 0.2)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)'
        ],
        borderWidth: 1
      },
      {
        label: 'RHTZ',
        data: BH_RHTZ_data,
        backgroundColor: [
          'rgba(54, 162, 235, 0.2)'
        ],
        borderColor: [
          'rgba(54, 162, 235, 1)'
        ],
        borderWidth: 1
      }
    ]
  },
  options: {
    plugins: {
      tooltip: {
        callbacks: {
          label: function(tooltipItem) {
            var Data = baselineHistoricalChart.data;
            var index = tooltipItem.dataIndex;
            console.log(index)
            var LHTZ_value = 0;
            var RHTZ_value = 0;
            if (Data && Data.datasets[0].data[index]) {
                LHTZ_value = Data.datasets[0].data[index];
            }
            if (Data && Data.datasets[1].data[index]) {
                RHTZ_value = Data.datasets[1].data[index];
            }
            var difference = RHTZ_value - LHTZ_value;
            var difference_percent = (difference / LHTZ_value * 100).toFixed(2);
            return "LHTZ: " + LHTZ_value + " kg\n" + "RHTZ: " + RHTZ_value + " kg\n" + "Asymmetry: " + difference_percent + "%";
          }
        }
      }
    },
    scales: {
      y: {
        title: {
          text: 'Force (kg)',
          color: 'black',
          display: true
        },
        border: {
          color: 'black'
        },
        ticks: {
          color: 'black'
        }
      },
      x: {
        title: {
          text: 'Session (protocol: date)',
          color: 'black',
          display: true
        },
        border: {
          color: 'black'
        },
        ticks: {
          color: 'black'
        }
      },
      yAxes: [{
        ticks: {
          beginAtZero: true
        }
      }]
    }
  }
});

function filterData3(data, metric) {
    // Retrieve the data for LHTZ and RHTZ
    var dataDict = {{ baselineHistoricalData|tojson|safe }};
    // Extract the data for the chart
    var LHTZ_data = [];
    var RHTZ_data = [];
    for (var session in dataDict) {
      LHTZ_data.push(dataDict[session]['LHTZ'][data][metric][0]);
      RHTZ_data.push(dataDict[session]['RHTZ'][data][metric][0]);
    }

    // Return the filtered data
    return {'LHTZ': LHTZ_data, 'RHTZ': RHTZ_data};
}

function updateChartData3(filteredData3) {
    // Update the data for the LHTZ dataset
    baselineHistoricalChart.data.datasets[0].data = filteredData3['LHTZ'];
    // Update the data for the RHTZ dataset
    baselineHistoricalChart.data.datasets[1].data = filteredData3['RHTZ'];
    // Update the chart
    baselineHistoricalChart.update();
}

function updateTable3(filteredData3) {
    // Get a reference to the table element
    var table = document.getElementById("baseline-historical-table");
    // Clear the existing content of the table
    table.innerHTML = "";

    // Create the table headers
    var headers = ["Test number", "LHTZ score (kg)", "RHTZ score (kg)", "Asymmetry (%)"];
    var headerRow = document.createElement("tr");
    for (var i = 0; i < headers.length; i++) {
        var headerCell = document.createElement("th");
        headerCell.innerHTML = headers[i];
        headerRow.appendChild(headerCell);
    }
    table.appendChild(headerRow);

    // Create the table rows
    for (var i = 0; i < session_names.length; i++) {
        var row = document.createElement("tr");
        var testCell = document.createElement("td");
        testCell.innerHTML = session_names[i];
        row.appendChild(testCell);

        var LHTZValue = filteredData3['LHTZ'][i];
        var RHTZValue = filteredData3['RHTZ'][i];
        var LHTZCell = document.createElement("td");
        LHTZCell.innerHTML = LHTZValue;
        row.appendChild(LHTZCell);

        var RHTZCell = document.createElement("td");
        RHTZCell.innerHTML = RHTZValue;
        row.appendChild(RHTZCell);

        var percentageDiff = ((RHTZValue - LHTZValue) / LHTZValue) * 100;
        var diffCell = document.createElement("td");
        diffCell.innerHTML = percentageDiff.toFixed(2);
        row.appendChild(diffCell);

        table.appendChild(row);
    }
}

// Get references to the select elements
var metricSelect3 = document.getElementById("bh-metric-select");
metricSelect3.addEventListener("change", updateChart3);
var dataSelect3 = document.getElementById("bh-type-select");
dataSelect3.addEventListener("change", updateChart3);
// Function to update the chart when a new option is selected
function updateChart3() {
    var selectedMetric3 = metricSelect3.options[metricSelect3.selectedIndex].text;
    var selectedData3 = dataSelect3.options[dataSelect3.selectedIndex].value;
    var filteredData3 = filterData3(selectedData3, selectedMetric3);
    updateChartData3(filteredData3);
    updateTable3(filteredData3);
  }
updateChart3();
</script>

<script>
  // Get the data from the LHTZ_data and RHTZ_data dictionaries
var data4 = {{ fatigueHistoricalData|tojson|safe }};

// Extract the session names
var session_names2 = [];
for (var session in data4) {
  session_names2.push(session);
}

// Extract the data for the chart
var FH_LHTZ_data = [];
var FH_RHTZ_data = [];
for (var session in data4) {
  FH_LHTZ_data.push(data4[session]['LHTZ']['max']['Front leg force at 150ms'][0]);
  FH_RHTZ_data.push(data4[session]['RHTZ']['max']['Front leg force at 150ms'][0]);
}

// Create a new chart
const ctx4 = document.getElementById("fatigueHistoricalChart").getContext("2d");
const fatigueHistoricalChart = new Chart(ctx4, {
  type: "bar",
  data: {
    labels: session_names2,
    datasets: [{
        label: 'LHTZ',
        data: FH_LHTZ_data,
        backgroundColor: [
          'rgba(128, 0, 128, 0.2)'
        ],
        borderColor: [
          'rgba(128, 0, 128, 1)'
        ],
        borderWidth: 1
      },
      {
        label: 'RHTZ',
        data: FH_RHTZ_data,
        backgroundColor: [
          'rgba(0,128,0,0.2)'
        ],
        borderColor: [
          'rgba(0,128,0,1)'
        ],
        borderWidth: 1
      }
    ]
  },
  options: {
     plugins: {
        tooltip: {
          callbacks: {
            label: function(tooltipItem) {
              var Data = fatigueHistoricalChart.data;
              var index = tooltipItem.dataIndex;
              console.log(index)
              var LHTZ_value = 0;
              var RHTZ_value = 0;
              if (Data && Data.datasets[0].data[index]) {
                  LHTZ_value = Data.datasets[0].data[index];
              }
              if (Data && Data.datasets[1].data[index]) {
                  RHTZ_value = Data.datasets[1].data[index];
              }
              var difference = RHTZ_value - LHTZ_value;
              var difference_percent = (difference / LHTZ_value * 100).toFixed(2);
              return "LHTZ: " + LHTZ_value + " kg\n" + "RHTZ: " + RHTZ_value + " kg\n" + "Asymmetry: " + difference_percent + "%";
            }
          }
        }
      },
    scales: {
      y: {
        title: {
          text: 'Force (kg)',
          color: 'black',
          display: true
        },
        border: {
          color: 'black'
        },
        ticks: {
          color: 'black'
        }
      },
      x: {
        title: {
          text: 'Session (protocol: date)',
          color: 'black',
          display: true
        },
        border: {
          color: 'black'
        },
        ticks: {
          color: 'black'
        }
      },
      yAxes: [{
        ticks: {
          beginAtZero: true
        }
      }]
    }
  }
});

function filterData4(data, metric) {
    // Retrieve the data for LHTZ and RHTZ
    var dataDict2 = {{ fatigueHistoricalData|tojson|safe }};
    // Extract the data for the chart
    var LHTZ_data = [];
    var RHTZ_data = [];
    for (var session in dataDict2) {
      LHTZ_data.push(dataDict2[session]['LHTZ'][data][metric][0]);
      RHTZ_data.push(dataDict2[session]['RHTZ'][data][metric][0]);
    }

    // Return the filtered data
    return {'LHTZ': LHTZ_data, 'RHTZ': RHTZ_data};
}

function updateChartData4(filteredData4) {
    // Update the data for the LHTZ dataset
    fatigueHistoricalChart.data.datasets[0].data = filteredData4['LHTZ'];
    // Update the data for the RHTZ dataset
    fatigueHistoricalChart.data.datasets[1].data = filteredData4['RHTZ'];
    // Update the chart
    fatigueHistoricalChart.update();
}

function updateTable4(filteredData4) {
    // Get a reference to the table element
    var table = document.getElementById("fatigue-historical-table");
    // Clear the existing content of the table
    table.innerHTML = "";

    // Create the table headers
    var headers = ["Test number", "LHTZ score (kg)", "RHTZ score (kg)", "Asymmetry (%)"];
    var headerRow = document.createElement("tr");
    for (var i = 0; i < headers.length; i++) {
        var headerCell = document.createElement("th");
        headerCell.innerHTML = headers[i];
        headerRow.appendChild(headerCell);
    }
    table.appendChild(headerRow);

    // Create the table rows
    for (var i = 0; i < session_names2.length; i++) {
        var row = document.createElement("tr");
        var testCell = document.createElement("td");
        testCell.innerHTML = session_names[i];
        row.appendChild(testCell);

        var LHTZValue = filteredData4['LHTZ'][i];
        var RHTZValue = filteredData4['RHTZ'][i];
        var LHTZCell = document.createElement("td");
        LHTZCell.innerHTML = LHTZValue;
        row.appendChild(LHTZCell);

        var RHTZCell = document.createElement("td");
        RHTZCell.innerHTML = RHTZValue;
        row.appendChild(RHTZCell);

        var percentageDiff = ((RHTZValue - LHTZValue) / LHTZValue) * 100;
        var diffCell = document.createElement("td");
        diffCell.innerHTML = percentageDiff.toFixed(2);
        row.appendChild(diffCell);

        table.appendChild(row);
    }
}

// Get references to the select elements
var metricSelect4 = document.getElementById("fh-metric-select");
metricSelect4.addEventListener("change", updateChart4);
var dataSelect4 = document.getElementById("fh-type-select");
dataSelect4.addEventListener("change", updateChart4);
// Function to update the chart when a new option is selected
function updateChart4() {
    var selectedMetric4 = metricSelect4.options[metricSelect4.selectedIndex].text;
    var selectedData4 = dataSelect4.options[dataSelect4.selectedIndex].value;
    var filteredData4 = filterData4(selectedData4, selectedMetric4);
    updateChartData4(filteredData4);
    updateTable4(filteredData4);
  }
updateChart4();
</script>







    <script>
      const activityLabels = {{ timeStr|safe }}
      const activityData = {
        labels: activityLabels,
        datasets: [{
          label: 'Tests completed',
          data: {{ countExt|safe }},
          fill: true,
          borderColor: 'rgb(100, 75, 185)',
          tension: 0.05
        }]
      }

      const ctx5 = document.getElementById("activityChart").getContext("2d");
      const activityChart = new Chart(ctx5, {
          type: "line",
          data: activityData,
          options: {
            scales: {
                y:{
                  min:0,
                  max:20,
                  title:{
                    text: 'Number of completed tests',
                    display: true
                  }
                }
            }
          }
      });
    </script>




{% endblock %}
</body>
</html>